{% extends "base.html" %}

{% block demo_title %}Blog listing{% endblock %}

{% block title %}Blog{% endblock %}

{% block desc %}The official blog of the Consumer Financial Protection Bureau{% endblock %}

{% block content %}

    {% set active_filters =
       selected_filters_for_field('category') +
       selected_filters_for_field('tags') +
       selected_filters_for_field('author')
    %}

    {% set active_date_filters =
       selected_filters_for_field('range_date_gte') + 
       selected_filters_for_field('range_date_lte')
    %}

    {% set active_filters_total = active_filters|length + active_date_filters|length %}

    {% set posts = queries.posts.search_with_url_arguments(size=10) %}
    {% set view = get_document('views', 'blog') %}

    {% macro filter_checkbox(field, value, classes, hidden) %}
        <input class="custom-input"
               type="checkbox"
               name="filter_{{ field }}"
               value="{{ value }}"
               {%- if is_filter_selected(field, value) %}
               checked
               {%- endif -%}
               >
            {{ value }}
    {% endmacro %}

    {% macro filter_option(field, value) %}
        <option value="{{ value }}"
            {%- if is_filter_selected(field, value) %}
                selected
            {%- endif -%}
                >
            {{ value }}
        </option>
    {% endmacro %}

    {% macro print_hidden_filters(filter_fields) %}
        {%- for field in filter_fields -%}
            {% set selected_filters = selected_filters_for_field(field) %}
            {%- for value in selected_filters -%}
                {%- if value %}
                <input type="hidden" name="filter_{{ field }}" value="{{ value }}">
                {%- endif -%}
            {%- endfor -%}
        {%- endfor -%}
    {% endmacro %}

    {% macro category_icon(category, additional_classes) %}
        {%- if category|lower == 'announcements & updates' -%}
        <span class="{{ additional_classes }} cf-icon cf-icon-bullhorn"></span>
        {% elif category|lower == 'consumer information' -%}
        <span class="{{ additional_classes }} cf-icon cf-icon-information"></span>
        {% elif category|lower == 'engagement' -%}
        <span class="{{ additional_classes }} cf-icon cf-icon-dialogue"></span>
        {% elif category|lower == 'innovation & data' -%}
        <span class="{{ additional_classes }} cf-icon cf-icon-lightbulb"></span>
        {%- endif -%}
    {% endmacro %}

    <main class="content content__2-1 content__bleedbar" id="main" role="main">

        <!-- .content_bar must come after .content_hero but before .content_wrapper -->
        <div class="content_bar"></div>

        <div class="wrapper content_wrapper">
            <section class="content_main">

            <div class="expandable">
                <div class="expandable_header expandable_header__spaced">
                    <div class="expandable_header-right expandable_header-right__float-on-medium">
                        <a class="expandable_target btn btn-secondary"
                           href="#post-filters-form">
                            Filter newsroom
                            <span class="expandable_cue-open">
                                <span class="btn-icon-right cf-icon cf-icon-down"></span>
                            </span>
                            <span class="expandable_cue-close">
                                <span class="btn-icon-right cf-icon cf-icon-up"></span>
                            </span>
                        </a>
                    </div>
                {% if active_filters_total > 0 %}
                    <dl class="filtered-by filtered-by__show-on-medium filtered-by__align-with-btn list list__horizontal">
                        <dt class="list_item">
                            <span class="filtered-by_header">
                            {%- if posts|list|length > 0 -%}
                                {{ posts.total }} filtered result{{ 's' if posts.total > 1 }} for
                            {%- else -%}
                                No results for
                            {%- endif -%}
                            </span>
                        </dt>
                    {% for filter in active_filters %}
                        <dd class="list_item">
                            <span class="filtered-by_filter">
                                {{ filter }}
                                {%- if not loop.last -%}
                                ,
                                {%- elif active_date_filters|length > 0 -%}
                                ,
                                {%- endif -%}
                            </span>
                        </dd>
                    {% endfor %}
                    {% for filter in active_date_filters %}
                        <dd class="list_item">
                            <span class="filtered-by_filter">
                                {{ filter | date("%B %Y") }}
                                {% if not loop.last -%}&nbsp;&ndash;{% endif %}
                            </span>
                        </dd>
                    {% endfor %}
                    </dl>
                {% endif %}
                </div>
                <div class="expandable_content padded-container">
                    <div class="padded-container_body">
                        {% include "filters.html" %}
                    </div>
                </div>
            </div><!-- END .expandable -->

            {% include "posts-paginated.html" %}

            </section><!-- END .content_main -->

            <aside class="content_sidebar">
                <section class="content_sidebar-item popular-stories">
                    <h1 class="header-slug">
                        <span class="header-slug_inner">
                            Popular stories
                        </span>
                    </h1>
                    <ul class="list list__unstyled list__spaced">
                        {% for slug in view.popular_posts %}
                        {% set pop_post = get_document('posts', slug) %}
                        <li class="list_item">
                            <a class="list_link"
                               href="{{ pop_post.permalink }}">
                                {{ pop_post.title }}
                            </a>
                        </li>
                        {% endfor %}
                    </ul>
                </section>
                <section class="content_sidebar-item related-links">
                    <h1 class="header-slug">
                        <span class="header-slug_inner">
                            Related links
                        </span>
                    </h1>
                    <ul class="list list__unstyled list__spaced">
                        {% for link in view.related_links %}
                        <li class="list_item">
                            <a class="list_link"
                               href="{{ link[0] }}">
                                {{ link[1] }}
                            </a>
                        </li>
                        {% endfor %}
                    </ul>
                </section>
                <section class="content_sidebar-item stay-informed">
                    <div class="demo-placeholder">stay informed placeholder</div>
                </section>
            </aside><!-- END .content_sidebar -->

        </div><!-- END .content_wrapper -->
    </main><!-- END .content -->

{% endblock content %}
