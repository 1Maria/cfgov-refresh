{% extends "base.html" %}
{% import "macros.html" as macros %}

{% block demo_title -%}
    History
{%- endblock %}

{% block title -%}
    History
{%- endblock %}

{% block desc -%}
    History
{%- endblock %}

{% block content %}

    {# Variables #}

    {% set path = '/the-bureau/' %}
    {% set active_page = 'history' %}
    {% set query = queries.history %}

    {# Macros #}

    {% import "post-macros.html" as post_macros %}

    <main class="content content__1-3" id="main" role="main">

        <!-- .content_bar must come after .content_hero but before .content_wrapper -->
        <div class="content_bar"></div>

        <div class="wrapper content_wrapper">

            <aside class="content_sidebar content__flush-all-on-small">
                {% include "nav.html" %}
            </aside>

            <div class="content_main content__flush-top-on-small">
                <section>

                    <div class="content_block content_block__flush-top">
                        <h1 class="content_title__extra-large">
                            The history of the Consumer Financial Protection Bureau
                        </h1>
                        <p class="content_desc__large">
                            Richard Cordray serves as the first Director of the
                            Consumer Financial Protection Bureau.
                            He previously led the Bureauâ€™s Enforcement Division.
                        </p>
                        {{ macros.share(self.title(), true) }}
                    </div>

                {% set sections = query.search_with_url_arguments(q="has_parent:false") -%}

                {% for section in sections %}

                    <section class="content_block content_block__padded-top content_block__border-top">
                        <div class="content-l">
                            <div class="content-l_col content-l_col-2-3">
                                <h1 class="content_title__large">{{ section.title|safe }}</h1>
                                <p class="short-desc">
                                    {{ section.section_date_from }} &ndash; {{ section.section_date_to }}
                                </p>
                                {{ section.content|safe }}
                            </div>

                        {% if section.thumbnail.images %}
                            <figure class="content-l_col content-l_col-1-3">
                                <img src="{{ section.thumbnail.images.full.url }}"
                                     alt="{{ section.thumbnail.alt_text }}"
                                     width="150">
                            </figure>
                        {% endif %}
                        </div>

                        <div class="expandable
                                    expandable__padded
                                    content_block__flush-sides
                                    history-expandable">
                            <div class="expandable_content">

                    {# Run a query for the first item in this section to get the starting year. #}
                    {% set first = query.search_with_url_arguments(q="parent:{}".format(section.id), size=1) %}
                    {# Using this vars dictionary instead of a simple variable lets us share the value
                       between the different scopes created by the foor loops.
                       See: http://stackoverflow.com/a/16746185/279566 #}
                    {% set vars = {'current_year': 9999} %}
                    {% for history in first %}
                        {% if vars.update({'current_year': history.date|date("%Y")|int}) %} {% endif %}
                    {% endfor %}
                    
                                <h2 class="history_year">{{ vars.current_year }}</h2>

                                <ol class="history_list">

                    {% set histories = query.search_with_url_arguments(q="parent:{}".format(section.id)) %}
                    {% for history in histories %}
                        {% if history.date|date("%Y")|int < vars.current_year %}
                            {% if vars.update({'current_year': history.date|date("%Y")|int}) %} {% endif %}
                                </ol>

                                <h2 class="history_year">{{ vars.current_year }}</h2>

                                <ol class="history_list">
                        {% endif %}
                                    <li class="history_item expandable expandable__padded">
                                        <button class="expandable_header expandable_target">
                                            <span class="expandable_header-right expandable_link">
                                                <span class="expandable_cue-open">
                                                    Show
                                                    <span class="cf-icon cf-icon-plus-round"></span>
                                                </span>
                                                <span class="expandable_cue-close">
                                                    Hide
                                                    <span class="cf-icon cf-icon-minus-round"></span>
                                                </span>
                                            </span>
                                            <h3 class="expandable_header-left
                                                         history_item_title">
                                                <span class="history_item_date">
                                                    {{ history.item_date if history.item_date
                                                       else history.date|date("%b %d, %Y") }}
                                                </span>
                                                {{ history.title|safe }}
                                            </h3>
                                        </button>
                                        <div class="expandable_content">
                                        {% if history.thumbnail.images %}
                                            <figure class="content-l_col content-l_col-1-3">
                                                <img src="{{ history.thumbnail.images.full.url }}"
                                                     alt="{{ history.thumbnail.alt_text }}"
                                                     width="150">
                                            </figure>
                                        {% endif %}
                                            {{ history.content|safe }}
                                        </div>
                                    </li>
                    {% endfor %}

                            </div><!-- END .history-expandable .expandable_content -->

                            <button class="expandable_header expandable_target">
                                <span class="expandable_header-left expandable_label">
                                    Timeline of our current history
                                </span>
                                <span class="expandable_header-right expandable_link">
                                    <span class="expandable_cue-open">
                                        Show
                                        <span class="cf-icon cf-icon-plus-round"></span>
                                    </span>
                                    <span class="expandable_cue-close">
                                        Hide
                                        <span class="cf-icon cf-icon-minus-round"></span>
                                    </span>
                                </span>
                            </button>
                        </div><!-- END .history-expandable -->
                    </section><!-- END .content_block -->

                {% endfor %}

                </section>
            </div><!-- END .content_main -->

        </div><!-- END .content_wrapper -->

    </main><!-- END .content -->

{% endblock %}